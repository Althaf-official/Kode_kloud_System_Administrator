
We have one of our websites up and running on our Nautilus infrastructure in Stratos DC. Our security team has raised a concern that right now Apacheâ€™s port i.e 8087 is open for all since there is no firewall installed on these hosts. So we have decided to add some security layer for these hosts and after discussions and recommendations we have come up with the following requirements:



1. Install iptables and all its dependencies on each app host.


2. Block incoming port 8087 on all apps for everyone except for LBR host.


3. Make sure the rules remain, even after system reboot.

4. -----

```ruby
Last login: Sun Dec 31 16:04:37 UTC 2023 on pts/4
thor@jump_host ~$ ssh banner@stapp03
The authenticity of host 'stapp03 (172.16.238.12)' can't be established.
ECDSA key fingerprint is SHA256:p8Hz1800JXSNOKUioYuy1FdGRz3iwWT+CXCKx+zy3CY.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'stapp03,172.16.238.12' (ECDSA) to the list of known hosts.
banner@stapp03's password: 
[banner@stapp03 ~]$ 
[banner@stapp03 ~]$ 
[banner@stapp03 ~]$ sudo su -

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for banner: 
[root@stapp03 ~]# yum install iptables-services
Updating Subscription Management repositories.
Unable to read consumer identity

This system is not registered with an entitlement server. You can use subscription-manager to register.

Last metadata expiration check: 0:11:51 ago on Sun Dec 31 16:20:20 2023.
Dependencies resolved.
============================================================================================
 Package                     Architecture     Version                Repository        Size
============================================================================================
Installing:
 iptables-services           x86_64           1.8.5-11.el8           baseos            65 k
Upgrading:
 iptables                    x86_64           1.8.5-11.el8           baseos           671 k
 iptables-libs               x86_64           1.8.5-11.el8           baseos           103 k

Transaction Summary
============================================================================================
Install  1 Package
Upgrade  2 Packages

Total download size: 839 k
Is this ok [y/N]: y
Downloading Packages:
(1/3): iptables-services-1.8.5-11.el8.x86_64.rpm            513 kB/s |  65 kB     00:00    
(2/3): iptables-libs-1.8.5-11.el8.x86_64.rpm                729 kB/s | 103 kB     00:00    
(3/3): iptables-1.8.5-11.el8.x86_64.rpm                     3.1 MB/s | 671 kB     00:00    
--------------------------------------------------------------------------------------------
Total                                                       2.5 MB/s | 839 kB     00:00     
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                                    1/1 
  Upgrading        : iptables-libs-1.8.5-11.el8.x86_64                                  1/5 
  Running scriptlet: iptables-1.8.5-11.el8.x86_64                                       2/5 
  Upgrading        : iptables-1.8.5-11.el8.x86_64                                       2/5 
  Running scriptlet: iptables-1.8.5-11.el8.x86_64                                       2/5 
  Installing       : iptables-services-1.8.5-11.el8.x86_64                              3/5 
  Running scriptlet: iptables-services-1.8.5-11.el8.x86_64                              3/5 
  Cleanup          : iptables-1.8.4-24.el8.x86_64                                       4/5 
  Running scriptlet: iptables-1.8.4-24.el8.x86_64                                       4/5 
  Cleanup          : iptables-libs-1.8.4-24.el8.x86_64                                  5/5 
  Running scriptlet: iptables-libs-1.8.4-24.el8.x86_64                                  5/5 
  Verifying        : iptables-services-1.8.5-11.el8.x86_64                              1/5 
  Verifying        : iptables-1.8.5-11.el8.x86_64                                       2/5 
  Verifying        : iptables-1.8.4-24.el8.x86_64                                       3/5 
  Verifying        : iptables-libs-1.8.5-11.el8.x86_64                                  4/5 
  Verifying        : iptables-libs-1.8.4-24.el8.x86_64                                  5/5 
Installed products updated.

Upgraded:
  iptables-1.8.5-11.el8.x86_64               iptables-libs-1.8.5-11.el8.x86_64              
Installed:
  iptables-services-1.8.5-11.el8.x86_64                                                     

Complete!
[root@stapp03 ~]# sudo cat > /etc/sysconfig/iptables
# Generated by iptables-save v1.8.5 on Sun Dec 31 15:55:00 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:DOCKER - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A DOCKER -i docker0 -j RETURN
COMMIT
# Completed on Sun Dec 31 15:55:00 2023
# Generated by iptables-save v1.8.5 on Sun Dec 31 15:55:00 2023
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [336:38758]
-A INPUT -p tcp --dport 8087 -s 172.16.238.14 -j ACCEPT
-A INPUT -p tcp --dport 8087 -j DROP
COMMIT
# Completed on Sun Dec 31 15:55:00 2023[root@stapp02 ~][root@stapp03 ~]# 
[root@stapp03 ~]# 
[root@stapp03 ~]# sudo systemctl restart iptables
[root@stapp03 ~]# 
```

The provided command sequence shows the process of connecting to a remote server (`stapp03`) using SSH, upgrading the `iptables` package, and configuring firewall rules. Here's an explanation of the key steps:

1. **SSH Connection:**
   ```bash
   ssh banner@stapp03
   ```
   - The user connects to the remote server `stapp03` with the username `banner` using SSH.
   - The authenticity of the host is verified, and the user is prompted to confirm the connection.

2. **Switch to Root User:**
   ```bash
   sudo su -
   ```
   - The user switches to the root user to perform administrative tasks.

3. **Install iptables-services:**
   ```bash
   yum install iptables-services
   ```
   - The `yum` package manager is used to install the `iptables-services` package.

4. **Configure iptables:**
   ```bash
   sudo cat > /etc/sysconfig/iptables
   ```
   - The user creates or overwrites the `/etc/sysconfig/iptables` file for configuring firewall rules.

5. **Provide iptables Rules:**
   - The user inputs iptables rules into the file. The rules specify how network traffic should be filtered and redirected.
   - The rules shown include NAT (Network Address Translation) and filtering rules.

6. **Restart iptables Service:**
   ```bash
   sudo systemctl restart iptables
   ```
   - The user restarts the `iptables` service to apply the new configuration.

7. **Verification:**
   - After the `iptables` service is restarted, the user can verify the changes by checking the rules using `iptables-save` or other related commands.

Note: The warning about the system not being registered with an entitlement server suggests that the system might not be subscribed to receive updates. It's generally a good practice to ensure that systems are properly subscribed and updated for security and stability reasons. The user should consider addressing this issue by using `subscription-manager` to register the system if required.

